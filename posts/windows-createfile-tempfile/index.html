<!doctype html><html lang=zh-cn id=page><head><meta charset=utf-8><title>Windows 创建临时文件 - Xhat Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/font.css type=text/css rel=stylesheet><link href=/css/main.css type=text/css rel=stylesheet><link href=/css/github-markdown-light.css type=text/css rel=stylesheet><link rel=icon href=/favicon.svg></head><body><header><a href=/ id=logo><svg xmlns="http://www.w3.org/2000/svg" width="38.82" height="52.68" viewBox="0 -765 572 776" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-9-TEX-I-78" d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6Q78-10 57 16T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35T107 46 94 41l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32T93 290q-2-9-5-10t-16-2H58q-6 6-6 11z"/><path id="MJX-9-TEX-N-5E" d="M112 560 249 694l8-8Q387 562 387 560l-26-29q-2 1-58 50l-53 46-55-47q-13-11-26-23t-21-19l-8-6q-2-2-15 14l-13 14z"/></defs><g stroke="currentcolor" fill="currentcolor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="TeXAtom"><g data-mml-node="mover"><g data-mml-node="mi"><use xlink:href="#MJX-9-TEX-I-78"/></g><g data-mml-node="mo" transform="translate(63.8, -29)"><use xlink:href="#MJX-9-TEX-N-5E"/></g></g></g></g></g></svg><b>xhat</b></a><nav><ul><li><a href=/ class=active>文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/archives/>归档</a></li><li><a href=/about/>关于</a></li></ul></nav></header><section class=main><article class=content><h2 class=title>Windows 创建临时文件</h2><div class=remark><time datetime="2021-07-19 09:36:38 +0800 +0800">2021-07-19</time></div><div class=tags><a href=/tags/windows/>Windows</a></div><div class=markdown-body><p>在 Windows 上希望创建一个临时文件，该文件在程序退出时自动删除，即使是被强制停止的。这时需要使用 <a href=https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea>CreateFile</a> 这个函数：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>HANDLE <span style=color:#900;font-weight:700>CreateFileA</span>(
</span></span><span style=display:flex><span>  [in]           LPCSTR                lpFileName, <span style=color:#998;font-style:italic>// 指向文件名的指针
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>  [in]           DWORD                 dwDesiredAccess, <span style=color:#998;font-style:italic>// 访问模式，写/读
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>  [in]           DWORD                 dwShareMode, <span style=color:#998;font-style:italic>// 共享模式
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>  [in, optional] LPSECURITY_ATTRIBUTES lpSecurityAttributes, <span style=color:#998;font-style:italic>// 指向安全属性的指针
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>  [in]           DWORD                 dwCreationDisposition, <span style=color:#998;font-style:italic>// 如何创建
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>  [in]           DWORD                 dwFlagsAndAttributes, <span style=color:#998;font-style:italic>// 文件属性
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>  [in, optional] HANDLE                hTemplateFile <span style=color:#998;font-style:italic>// 用于复制文件句柄
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>);
</span></span></code></pre></div><p>重点关注<code>dwShareMode</code>和<code>dwFlagsAndAttributes</code>这两个参数。</p><p>共享模式<code>dwShareMode</code>有四种选项，分别为</p><ul><li>0：禁止其他进程进行删除、读取和写入</li><li>FILE_SHARE_DELETE：允许删除</li><li>FILE_SHARE_READ：允许读取</li><li>FILE_SHARE_WRITE：允许写入</li></ul><p>文件属性<code>dwFlagsAndAttributes</code>需要设定两项：</p><ul><li>FILE_ATTRIBUTE_TEMPORARY：该文件为临时文件，尽可能使用内存缓存，避免写入磁盘。</li><li>FILE_FLAG_DELETE_ON_CLOSE：当所有句柄被关闭时，立刻删除文件。</li></ul><p>实验：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>h, _ <span style=color:#000;font-weight:700>:=</span> windows.<span style=color:#900;font-weight:700>CreateFile</span>(
</span></span><span style=display:flex><span>    windows.<span style=color:#900;font-weight:700>StringToUTF16Ptr</span>(<span style=color:#d14>&#34;tmp&#34;</span>), windows.GENERIC_WRITE, windows.FILE_SHARE_READ, <span style=color:#000;font-weight:700>nil</span>,
</span></span><span style=display:flex><span>    windows.OPEN_ALWAYS, windows.FILE_ATTRIBUTE_TEMPORARY|windows.FILE_FLAG_DELETE_ON_CLOSE,
</span></span><span style=display:flex><span>	<span style=color:#099>0</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>var</span> done <span style=color:#458;font-weight:700>uint32</span>
</span></span><span style=display:flex><span>windows.<span style=color:#900;font-weight:700>WriteFile</span>(h, []<span style=color:#0086b3>byte</span>(<span style=color:#d14>&#34;hello world&#34;</span>), <span style=color:#000;font-weight:700>&amp;</span>done, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>time.<span style=color:#900;font-weight:700>Sleep</span>(<span style=color:#099>60</span> <span style=color:#000;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span>windows.<span style=color:#900;font-weight:700>CloseHandle</span>(h)
</span></span></code></pre></div><p>发现<code>tmp</code>文件被成功创建，但当用记事本打开时，提示另一个程序正在使用此文件，进程无法访问。我们在创建时已经指定了<code>FILE_SHARE_READ</code>了，应该可以被其他进程读取才对。
很多文本编辑器都无法正常打开这个文件，但有例外的，比如 Sublime Text，Git Bash 的<code>cat</code>命令(和 MinGW 有关)等，都能正常读取文件内容。</p><p>调查发现，当文件指定了<code>FILE_FLAG_DELETE_ON_CLOSE</code>时，其他进程必须用<code>FILE_SHARE_DELETE</code>模式才能正常打开文件。目前很多程序或编程语言都没有默认使用这个模式打开文件的，因此大部分程序都打不开。
Golang 曾有这方面的<a href=https://github.com/golang/go/issues/32088>讨论</a>，但最终没有被采用。
如果读取的程序是自己开发的，那可以手动用这个 API 函数读取文件；如果是其他第三方程序，那可能需要考虑其他方法了。</p></div><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js onload='renderMathInElement(document.querySelector(`.content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></article></section><section class=tail><div class=content id=post-nav><a title="Python 进行 ARP 欺骗" rel=prev href=/posts/python-arpspoof/><span>前篇</span>Python 进行 ARP 欺骗</a>
<a title="Golang 打开 Windows 服务属性窗口" rel=next href=/posts/golang-service-property/><span>后篇</span>Golang 打开 Windows 服务属性窗口</a></div><div class=content id=post-comment><script src=https://giscus.app/client.js data-repo=koho/blog data-repo-id="MDEwOlJlcG9zaXRvcnkzMjM1MDUxMDk=" data-category=Announcements data-category-id=DIC_kwDOE0hL1c4COeTz data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div></section><footer><span>Powered by <a href=https://gohugo.io>Hugo</a></span><br><span>© 2022 xhat</span></footer></body></html>