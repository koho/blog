<!doctype html><html lang=zh-CN id=page><head><meta charset=utf-8><title>Linux 部署 Nginx - X̂ Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/font.css type=text/css rel=stylesheet><link href=/css/main.css type=text/css rel=stylesheet><link href=/css/github-markdown-light.css type=text/css rel=stylesheet><link rel=icon href=/favicon.svg></head><body><header><a href=/ id=logo><svg xmlns="http://www.w3.org/2000/svg" width="38.82" height="52.68" viewBox="0 -765 572 776" xmlns:xlink="http://www.w3.org/1999/xlink" style><defs><path id="MJX-9-TEX-I-78" d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6Q78-10 57 16T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35T107 46 94 41l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32T93 290q-2-9-5-10t-16-2H58q-6 6-6 11z"/><path id="MJX-9-TEX-N-5E" d="M112 560 249 694l8-8Q387 562 387 560l-26-29q-2 1-58 50l-53 46-55-47q-13-11-26-23t-21-19l-8-6q-2-2-15 14l-13 14z"/></defs><g stroke="currentcolor" fill="currentcolor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="TeXAtom"><g data-mml-node="mover"><g data-mml-node="mi"><use xlink:href="#MJX-9-TEX-I-78"/></g><g data-mml-node="mo" transform="translate(63.8, -29)"><use xlink:href="#MJX-9-TEX-N-5E"/></g></g></g></g></g></svg><b>xhat</b></a><nav><ul><li><a href=/ class=active>文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/archives/>归档</a></li><li><a href=/about/>关于</a></li></ul></nav></header><section class=main><article class=content><h2 class=title>Linux 部署 Nginx</h2><div class=remark><time datetime="2021-12-14 00:09:32 +0800 +0800">2021-12-14</time></div><div class=tags><a href=/tags/linux/>Linux</a></div><div class=markdown-body><h2 id=安装>安装</h2><p>参考官网的<a href=https://nginx.org/en/linux_packages.html>安装文档</a>。</p><h2 id=静态网站>静态网站</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#998;font-style:italic># 强制跳转HTTPS</span>
</span></span><span style=display:flex><span>server <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    listen 80;
</span></span><span style=display:flex><span>    server_name example.com;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#099>301</span> https://<span style=color:teal>$http_host$request_uri</span>;
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    listen       <span style=color:#099>443</span> ssl http2;
</span></span><span style=display:flex><span>    ssl_certificate /etc/example.com.crt;
</span></span><span style=display:flex><span>    ssl_certificate_key /etc/example.com.key;
</span></span><span style=display:flex><span>    ssl_protocols TLSv1.3 TLSv1.2;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    server_name  example.com;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>#access_log  /var/log/nginx/host.access.log  main;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    location / <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        root   /usr/share/app/html;
</span></span><span style=display:flex><span>        index  index.html index.htm;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>#error_page  404              /404.html;</span>
</span></span><span style=display:flex><span>    error_page <span style=color:#099>497</span> https://<span style=color:teal>$http_host$request_uri</span>;
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># redirect server error pages to the static page /50x.html</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>#</span>
</span></span><span style=display:flex><span>    error_page   <span style=color:#099>500</span> <span style=color:#099>502</span> <span style=color:#099>503</span> <span style=color:#099>504</span>  /50x.html;
</span></span><span style=display:flex><span>    <span style=color:teal>location</span> <span style=color:#000;font-weight:700>=</span> /50x.html <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        root   /usr/share/nginx/html;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=代理网站>代理网站</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>server<span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    listen <span style=color:#099>8888</span> ssl http2;
</span></span><span style=display:flex><span>    listen <span style=color:#000;font-weight:700>[</span>::<span style=color:#000;font-weight:700>]</span>:8888 ssl http2;
</span></span><span style=display:flex><span>    ssl_certificate /etc/example.com.crt;
</span></span><span style=display:flex><span>    ssl_certificate_key /etc/example.com.key;
</span></span><span style=display:flex><span>    ssl_protocols TLSv1.3 TLSv1.2;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    server_name example.com;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    location / <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        proxy_set_header  X-Real-IP        <span style=color:teal>$remote_addr</span>;
</span></span><span style=display:flex><span>        proxy_set_header  X-Forwarded-For  <span style=color:teal>$proxy_add_x_forwarded_for</span>;
</span></span><span style=display:flex><span>        proxy_set_header Host <span style=color:teal>$http_host</span>;
</span></span><span style=display:flex><span>        proxy_redirect off;
</span></span><span style=display:flex><span>        proxy_pass http://127.0.0.1:5212;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    error_page <span style=color:#099>497</span> https://<span style=color:teal>$http_host$request_uri</span>;
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=前后端分离>前后端分离</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>server <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    listen 8934;
</span></span><span style=display:flex><span>    listen <span style=color:#000;font-weight:700>[</span>::<span style=color:#000;font-weight:700>]</span>:8934;
</span></span><span style=display:flex><span>    root /usr/share/app/dist;
</span></span><span style=display:flex><span>    index index.html;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    location /api/ <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        proxy_set_header  X-Real-IP        <span style=color:teal>$remote_addr</span>;
</span></span><span style=display:flex><span>        proxy_set_header  X-Forwarded-For  <span style=color:teal>$proxy_add_x_forwarded_for</span>;
</span></span><span style=display:flex><span>        proxy_redirect / /api/;
</span></span><span style=display:flex><span>        proxy_pass http://127.0.0.1:8000/;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    location /assets/ <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        proxy_set_header  X-Real-IP        <span style=color:teal>$remote_addr</span>;
</span></span><span style=display:flex><span>        proxy_set_header  X-Forwarded-For  <span style=color:teal>$proxy_add_x_forwarded_for</span>;
</span></span><span style=display:flex><span>        proxy_pass http://127.0.0.1:8000/assets/;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=常用参数>常用参数</h2><ol><li><p><code>proxy_redirect</code><br>修改从被代理服务器传来的应答头中的<code>Location</code>和<code>Refresh</code>字段。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>proxy_redirect <span style=color:#000;font-weight:700>[</span> default|off|redirect replacement <span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><p>以下两个配置等效：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>location /test/ <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    proxy_pass     http://s1:port/test1/;
</span></span><span style=display:flex><span>    proxy_redirect default;
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>location /test/ <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    proxy_pass     http://s1:port/test1/;
</span></span><span style=display:flex><span>    proxy_redirect http://s1:port/test1/ /test/;
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>相对跳转常用：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>proxy_redirect / /api/;
</span></span></code></pre></div></li><li><p><code>proxy_set_header Host</code></p><ul><li><code>$host</code> 浏览器地址，没有端口</li><li><code>$host:$proxy_port</code> 浏览器地址 + 代理端口</li><li><code>$http_host</code> 浏览器地址 + 浏览器端口</li></ul></li><li><p><code>proxy_set_header X-Real-IP $remote_addr</code><br>设置用户真实的地址，用于一级代理。</p></li><li><p><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for</code><br>记录每级代理的来源地址，以逗号分隔。真实用户地址取第一个元素。</p></li></ol></div><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js onload='renderMathInElement(document.querySelector(`.content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></article></section><section class=tail><div class=content id=post-nav><a title="Golang 程序以 Windows 服务运行" rel=prev href=/posts/golang-windows-service/><span>前篇</span>Golang 程序以 Windows 服务运行</a>
<a title="Git 备忘" rel=next href=/posts/git-remind/><span>后篇</span>Git 备忘</a></div><div class=content id=post-comment><script src=https://giscus.app/client.js data-repo=koho/blog data-repo-id="MDEwOlJlcG9zaXRvcnkzMjM1MDUxMDk=" data-category=Announcements data-category-id=DIC_kwDOE0hL1c4COeTz data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div><div class=content id=post-related><h3 class=title>延伸阅读</h3><div class=grid><div class=card><a href=/posts/linux-wireguard/ rel=bookmark><div class=banner style=background-image:url(/images/wireguard-ubuntu.jpg)></div><h4>Linux 部署 WireGuard</h4><p>2021-09-03</p><div class=tags><span>Linux</span>
<span>网络</span></div></a></div></div></div></section><footer><span>Powered by <a href=https://gohugo.io>Hugo</a></span><br><span>© 2023 xhat</span></footer></body></html>