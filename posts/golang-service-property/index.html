<!doctype html><html lang=zh-cn id=page><head><meta charset=utf-8><title>Golang 打开 Windows 服务属性窗口 - Xhat Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/font.css type=text/css rel=stylesheet><link href=/css/main.css type=text/css rel=stylesheet><link href=/css/github-markdown-light.css type=text/css rel=stylesheet><link rel=icon href=/favicon.svg></head><body><header><a href=/ id=logo><svg xmlns="http://www.w3.org/2000/svg" width="38.82" height="52.68" viewBox="0 -765 572 776" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-9-TEX-I-78" d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6Q78-10 57 16T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35T107 46 94 41l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32T93 290q-2-9-5-10t-16-2H58q-6 6-6 11z"/><path id="MJX-9-TEX-N-5E" d="M112 560 249 694l8-8Q387 562 387 560l-26-29q-2 1-58 50l-53 46-55-47q-13-11-26-23t-21-19l-8-6q-2-2-15 14l-13 14z"/></defs><g stroke="currentcolor" fill="currentcolor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="TeXAtom"><g data-mml-node="mover"><g data-mml-node="mi"><use xlink:href="#MJX-9-TEX-I-78"/></g><g data-mml-node="mo" transform="translate(63.8, -29)"><use xlink:href="#MJX-9-TEX-N-5E"/></g></g></g></g></g></svg><b>xhat</b></a><nav><ul><li><a href=/ class=active>文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/archives/>归档</a></li><li><a href=/about/>关于</a></li></ul></nav></header><section class=main><article class=content><h2 class=title>Golang 打开 Windows 服务属性窗口</h2><div class=remark><time datetime="2021-08-01 11:35:17 +0800 +0800">2021-08-01</time></div><div class=tags><a href=/tags/golang/>Golang</a>
<a href=/tags/windows/>Windows</a></div><div class=markdown-body><p>本文介绍如何在 Golang 程序里面打开某个 Windows 服务的属性窗口，这里需要用到 COM 接口，详细文档请参考 MMC 2.0 的<a href=https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mmc/mmc-programmer-s-guide-overview>官方文档</a>。</p><p>既然是 COM 的话，程序里也可以使用<code>cmd</code>或者<code>powershell</code>来调用 COM 打开服务窗口。下面介绍直接调用 COM 组件的方法：</p><p>使用 <a href=https://github.com/go-ole/go-ole>github.com/go-ole/go-ole</a> 这个库调用 COM：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;github.com/go-ole/go-ole&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;github.com/go-ole/go-ole/oleutil&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// 服务的显示名称
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>displayName <span style=color:#000;font-weight:700>:=</span> <span style=color:#d14>&#34;Windows Update&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ole.<span style=color:#900;font-weight:700>CoInitialize</span>(<span style=color:#099>0</span>)
</span></span><span style=display:flex><span>unknown, _ <span style=color:#000;font-weight:700>:=</span> oleutil.<span style=color:#900;font-weight:700>CreateObject</span>(<span style=color:#d14>&#34;MMC20.Application&#34;</span>)
</span></span><span style=display:flex><span>mmc, _ = unknown.<span style=color:#900;font-weight:700>QueryInterface</span>(ole.IID_IDispatch)
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// 读取服务
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>oleutil.<span style=color:#900;font-weight:700>MustCallMethod</span>(mmc, <span style=color:#d14>&#34;Load&#34;</span>, <span style=color:#d14>&#34;services.msc&#34;</span>)
</span></span><span style=display:flex><span>document <span style=color:#000;font-weight:700>:=</span> oleutil.<span style=color:#900;font-weight:700>MustGetProperty</span>(mmc, <span style=color:#d14>&#34;Document&#34;</span>).<span style=color:#900;font-weight:700>ToIDispatch</span>()
</span></span><span style=display:flex><span>view <span style=color:#000;font-weight:700>:=</span> oleutil.<span style=color:#900;font-weight:700>MustGetProperty</span>(document, <span style=color:#d14>&#34;ActiveView&#34;</span>).<span style=color:#900;font-weight:700>ToIDispatch</span>()
</span></span><span style=display:flex><span>list <span style=color:#000;font-weight:700>:=</span> oleutil.<span style=color:#900;font-weight:700>MustGetProperty</span>(view, <span style=color:#d14>&#34;ListItems&#34;</span>).<span style=color:#900;font-weight:700>ToIDispatch</span>()
</span></span><span style=display:flex><span>count <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>int</span>(oleutil.<span style=color:#900;font-weight:700>MustGetProperty</span>(list, <span style=color:#d14>&#34;Count&#34;</span>).Val)
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// 注意索引从1开始
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>:=</span> <span style=color:#099>1</span>; i <span style=color:#000;font-weight:700>&lt;=</span> count; i<span style=color:#000;font-weight:700>++</span> {
</span></span><span style=display:flex><span>    item <span style=color:#000;font-weight:700>:=</span> oleutil.<span style=color:#900;font-weight:700>MustCallMethod</span>(list, <span style=color:#d14>&#34;Item&#34;</span>, i).<span style=color:#900;font-weight:700>ToIDispatch</span>()
</span></span><span style=display:flex><span>	name <span style=color:#000;font-weight:700>:=</span> oleutil.<span style=color:#900;font-weight:700>MustGetProperty</span>(item, <span style=color:#d14>&#34;Name&#34;</span>).<span style=color:#900;font-weight:700>ToString</span>()
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> name <span style=color:#000;font-weight:700>==</span> displayName {
</span></span><span style=display:flex><span>	    oleutil.<span style=color:#900;font-weight:700>MustCallMethod</span>(view, <span style=color:#d14>&#34;Select&#34;</span>, item)
</span></span><span style=display:flex><span>	    <span style=color:#998;font-style:italic>// 显示属性窗口
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>		oleutil.<span style=color:#900;font-weight:700>MustCallMethod</span>(view, <span style=color:#d14>&#34;DisplaySelectionPropertySheet&#34;</span>)
</span></span><span style=display:flex><span>		item.<span style=color:#900;font-weight:700>Release</span>()
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>break</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	item.<span style=color:#900;font-weight:700>Release</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>time.<span style=color:#900;font-weight:700>Sleep</span>(<span style=color:#099>60</span> <span style=color:#000;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// 关闭窗口
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>oleutil.<span style=color:#900;font-weight:700>MustCallMethod</span>(document, <span style=color:#d14>&#34;Close&#34;</span>, <span style=color:#000;font-weight:700>false</span>)
</span></span><span style=display:flex><span>list.<span style=color:#900;font-weight:700>Release</span>()
</span></span><span style=display:flex><span>view.<span style=color:#900;font-weight:700>Release</span>()
</span></span><span style=display:flex><span>document.<span style=color:#900;font-weight:700>Release</span>()
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// 等待窗口关闭，不然会弹出提示框
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>time.<span style=color:#900;font-weight:700>Sleep</span>(<span style=color:#099>2</span> <span style=color:#000;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// 退出mmc
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>oleutil.<span style=color:#900;font-weight:700>CallMethod</span>(mmc, <span style=color:#d14>&#34;Quit&#34;</span>)
</span></span><span style=display:flex><span>mmc.<span style=color:#900;font-weight:700>Release</span>()
</span></span><span style=display:flex><span>ole.<span style=color:#900;font-weight:700>CoUninitialize</span>()
</span></span></code></pre></div></div><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js onload='renderMathInElement(document.querySelector(`.content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></article></section><section class=tail><div class=content id=post-nav><a title="Windows 创建临时文件" rel=prev href=/posts/windows-createfile-tempfile/><span>前篇</span>Windows 创建临时文件</a>
<a title="Linux 部署 WireGuard" rel=next href=/posts/linux-wireguard/><span>后篇</span>Linux 部署 WireGuard</a></div><div class=content id=post-comment><script src=https://giscus.app/client.js data-repo=koho/blog data-repo-id="MDEwOlJlcG9zaXRvcnkzMjM1MDUxMDk=" data-category=Announcements data-category-id=DIC_kwDOE0hL1c4COeTz data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div><div class=content id=post-related><h3 class=title>延伸阅读</h3><div class=grid><div class=card><a href=/posts/windows-createfile-tempfile/ rel=bookmark><div class=banner style=background-image:url(/images/temp-file.jpg)></div><h4>Windows 创建临时文件</h4><p>2021-07-19</p><div class=tags><span>Windows</span></div></a></div><div class=card><a href=/posts/golang-jwt/ rel=bookmark><div class=banner style=background-image:url(/images/golang-jwt.webp)></div><h4>Golang 中使用 JWT 进行认证</h4><p>2021-05-10</p><div class=tags><span>Golang</span>
<span>后端</span></div></a></div></div></div></section><footer><span>Powered by <a href=https://gohugo.io>Hugo</a></span><br><span>© 2022 xhat</span></footer></body></html>