<!doctype html><html lang=zh-cn id=page><head><meta charset=utf-8><title>Golang 在 Windows 下防止程序多开 - xhat's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/font.css type=text/css rel=stylesheet><link href=/css/main.css type=text/css rel=stylesheet><link href=/css/github-markdown-light.css type=text/css rel=stylesheet><link rel=icon href=/favicon.svg></head><body><header><a href=/ id=logo><svg xmlns="http://www.w3.org/2000/svg" width="38.82" height="52.68" viewBox="0 -765 572 776" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-9-TEX-I-78" d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6Q78-10 57 16T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35T107 46 94 41l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32T93 290q-2-9-5-10t-16-2H58q-6 6-6 11z"/><path id="MJX-9-TEX-N-5E" d="M112 560 249 694l8-8Q387 562 387 560l-26-29q-2 1-58 50l-53 46-55-47q-13-11-26-23t-21-19l-8-6q-2-2-15 14l-13 14z"/></defs><g stroke="currentcolor" fill="currentcolor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="TeXAtom"><g data-mml-node="mover"><g data-mml-node="mi"><use xlink:href="#MJX-9-TEX-I-78"/></g><g data-mml-node="mo" transform="translate(63.8, -29)"><use xlink:href="#MJX-9-TEX-N-5E"/></g></g></g></g></g></svg><b>xhat</b></a><nav><ul><li><a href=/ class=active>文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/archives/>归档</a></li><li><a href=/about/>关于</a></li></ul></nav></header><section class=main><article class=content><h2 class=title>Golang 在 Windows 下防止程序多开</h2><div class=remark><time datetime="2021-10-11 11:02:41 +0800 +0800">2021-10-11</time></div><div class=tags><a href=/tags/golang/>Golang</a>
<a href=/tags/windows/>Windows</a></div><div class=markdown-body><p>当用户运行多个程序实例，如果操作的是同一资源，可能会造成数据不一致。所以有一个防止多开的需求，原理上是利用 <a href=https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createmutexa>CreateMutex</a> 这个函数创建互斥对象。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>checkSingleton</span>() (windows.Handle, <span style=color:#458;font-weight:700>error</span>) {
</span></span><span style=display:flex><span>	path, err <span style=color:#000;font-weight:700>:=</span> os.<span style=color:#900;font-weight:700>Executable</span>()
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	hashName <span style=color:#000;font-weight:700>:=</span> md5.<span style=color:#900;font-weight:700>Sum</span>([]<span style=color:#0086b3>byte</span>(path))
</span></span><span style=display:flex><span>	name, err <span style=color:#000;font-weight:700>:=</span> syscall.<span style=color:#900;font-weight:700>UTF16PtrFromString</span>(<span style=color:#d14>&#34;Local\\&#34;</span> <span style=color:#000;font-weight:700>+</span> hex.<span style=color:#900;font-weight:700>EncodeToString</span>(hashName[:]))
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> windows.<span style=color:#900;font-weight:700>CreateMutex</span>(<span style=color:#000;font-weight:700>nil</span>, <span style=color:#000;font-weight:700>false</span>, name)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>检查<code>error</code>，如果是<code>syscall.ERROR_ALREADY_EXISTS</code>，则说明有一个程序已经在运行。</p><p>上面创建的互斥对象是局部的(有<code>Local</code>前缀)，多个用户登录还是可以同时多开程序的。如果需要全局限制，则替换为<code>Global</code>前缀。如果你的程序以服务的形式运行，则可能需要设置互斥对象的权限。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>checkSingleton</span>() (windows.Handle, <span style=color:#458;font-weight:700>error</span>) {
</span></span><span style=display:flex><span>	path, err <span style=color:#000;font-weight:700>:=</span> os.<span style=color:#900;font-weight:700>Executable</span>()
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#0086b3>panic</span>(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	hashName <span style=color:#000;font-weight:700>:=</span> md5.<span style=color:#900;font-weight:700>Sum</span>([]<span style=color:#0086b3>byte</span>(path))
</span></span><span style=display:flex><span>	name, err <span style=color:#000;font-weight:700>:=</span> syscall.<span style=color:#900;font-weight:700>UTF16PtrFromString</span>(<span style=color:#d14>&#34;Global\\&#34;</span> <span style=color:#000;font-weight:700>+</span> hex.<span style=color:#900;font-weight:700>EncodeToString</span>(hashName[:]))
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#0086b3>panic</span>(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	sa <span style=color:#000;font-weight:700>:=</span> windows.SecurityAttributes{}
</span></span><span style=display:flex><span>	sd, err <span style=color:#000;font-weight:700>:=</span> windows.<span style=color:#900;font-weight:700>SecurityDescriptorFromString</span>(<span style=color:#d14>&#34;D:(A;;GA;;;WD)&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#0086b3>panic</span>(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	sa.Length = <span style=color:#0086b3>uint32</span>(unsafe.<span style=color:#900;font-weight:700>Sizeof</span>(sa))
</span></span><span style=display:flex><span>	sa.SecurityDescriptor = sd
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> windows.<span style=color:#900;font-weight:700>CreateMutex</span>(<span style=color:#000;font-weight:700>&amp;</span>sa, <span style=color:#000;font-weight:700>false</span>, name)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>若要用户体验更好的话：如果程序已经在运行，则显示已在运行的程序的主窗口，然后退出本次程序的启动。我的思路是先查找本程序的窗口，然后对比窗口程序和本程序的文件路径，如果一致则显示该窗口。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>showMainWindow</span>() <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> windowToShow win.HWND
</span></span><span style=display:flex><span>	path, err <span style=color:#000;font-weight:700>:=</span> os.<span style=color:#900;font-weight:700>Executable</span>()
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	execFileInfo, err <span style=color:#000;font-weight:700>:=</span> os.<span style=color:#900;font-weight:700>Stat</span>(path)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	syscall.<span style=color:#900;font-weight:700>MustLoadDLL</span>(<span style=color:#d14>&#34;user32.dll&#34;</span>).<span style=color:#900;font-weight:700>MustFindProc</span>(<span style=color:#d14>&#34;EnumWindows&#34;</span>).<span style=color:#900;font-weight:700>Call</span>(
</span></span><span style=display:flex><span>		syscall.<span style=color:#900;font-weight:700>NewCallback</span>(<span style=color:#000;font-weight:700>func</span>(hwnd syscall.Handle, lparam <span style=color:#458;font-weight:700>uintptr</span>) <span style=color:#458;font-weight:700>uintptr</span> {
</span></span><span style=display:flex><span>			className <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>([]<span style=color:#458;font-weight:700>uint16</span>, windows.MAX_PATH)
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>if</span> _, err = win.<span style=color:#900;font-weight:700>GetClassName</span>(win.<span style=color:#900;font-weight:700>HWND</span>(hwnd), <span style=color:#000;font-weight:700>&amp;</span>className[<span style=color:#099>0</span>], <span style=color:#0086b3>len</span>(className)); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>return</span> <span style=color:#099>1</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>if</span> windows.<span style=color:#900;font-weight:700>UTF16ToString</span>(className) <span style=color:#000;font-weight:700>==</span> <span style=color:#d14>&#34;\\o/ Walk_MainWindow_Class \\o/&#34;</span> {
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>var</span> pid <span style=color:#458;font-weight:700>uint32</span>
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>var</span> imageName <span style=color:#458;font-weight:700>string</span>
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>var</span> imageFileInfo fs.FileInfo
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>if</span> _, err = windows.<span style=color:#900;font-weight:700>GetWindowThreadProcessId</span>(windows.<span style=color:#900;font-weight:700>HWND</span>(hwnd), <span style=color:#000;font-weight:700>&amp;</span>pid); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#000;font-weight:700>return</span> <span style=color:#099>1</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				imageName, err = <span style=color:#900;font-weight:700>getImageName</span>(pid)
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#000;font-weight:700>return</span> <span style=color:#099>1</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				imageFileInfo, err = os.<span style=color:#900;font-weight:700>Stat</span>(imageName)
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#000;font-weight:700>return</span> <span style=color:#099>1</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>if</span> os.<span style=color:#900;font-weight:700>SameFile</span>(execFileInfo, imageFileInfo) {
</span></span><span style=display:flex><span>					windowToShow = win.<span style=color:#900;font-weight:700>HWND</span>(hwnd)
</span></span><span style=display:flex><span>					<span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>return</span> <span style=color:#099>1</span>
</span></span><span style=display:flex><span>		}), <span style=color:#099>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> windowToShow <span style=color:#000;font-weight:700>!=</span> <span style=color:#099>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>if</span> win.<span style=color:#900;font-weight:700>IsIconic</span>(windowToShow) {
</span></span><span style=display:flex><span>			win.<span style=color:#900;font-weight:700>ShowWindow</span>(windowToShow, win.SW_RESTORE)
</span></span><span style=display:flex><span>		} <span style=color:#000;font-weight:700>else</span> {
</span></span><span style=display:flex><span>			win.<span style=color:#900;font-weight:700>SetForegroundWindow</span>(windowToShow)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>getImageName</span>(pid <span style=color:#458;font-weight:700>uint32</span>) (<span style=color:#458;font-weight:700>string</span>, <span style=color:#458;font-weight:700>error</span>) {
</span></span><span style=display:flex><span>	proc, err <span style=color:#000;font-weight:700>:=</span> windows.<span style=color:#900;font-weight:700>OpenProcess</span>(windows.PROCESS_QUERY_LIMITED_INFORMATION, <span style=color:#000;font-weight:700>false</span>, pid)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> <span style=color:#d14>&#34;&#34;</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>defer</span> windows.<span style=color:#900;font-weight:700>CloseHandle</span>(proc)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> exeNameBuf [<span style=color:#099>261</span>]<span style=color:#458;font-weight:700>uint16</span>
</span></span><span style=display:flex><span>	exeNameLen <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>uint32</span>(<span style=color:#0086b3>len</span>(exeNameBuf) <span style=color:#000;font-weight:700>-</span> <span style=color:#099>1</span>)
</span></span><span style=display:flex><span>	err = windows.<span style=color:#900;font-weight:700>QueryFullProcessImageName</span>(proc, <span style=color:#099>0</span>, <span style=color:#000;font-weight:700>&amp;</span>exeNameBuf[<span style=color:#099>0</span>], <span style=color:#000;font-weight:700>&amp;</span>exeNameLen)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> <span style=color:#d14>&#34;&#34;</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> windows.<span style=color:#900;font-weight:700>UTF16ToString</span>(exeNameBuf[:exeNameLen]), <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js onload='renderMathInElement(document.querySelector(`.content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></article></section><section class=tail><div class=content id=post-nav><a title="Linux 部署 WireGuard" rel=prev href=/posts/linux-wireguard/><span>前篇</span>Linux 部署 WireGuard</a>
<a title="Golang 程序以 Windows 服务运行" rel=next href=/posts/golang-windows-service/><span>后篇</span>Golang 程序以 Windows 服务运行</a></div><div class=content id=post-comment><script src=https://giscus.app/client.js data-repo=koho/blog data-repo-id="MDEwOlJlcG9zaXRvcnkzMjM1MDUxMDk=" data-category=Announcements data-category-id=DIC_kwDOE0hL1c4COeTz data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div><div class=content id=post-related><h3 class=title>延伸阅读</h3><div class=grid><div class=card><a href=/posts/golang-service-property/ rel=bookmark><div class=banner style=background-image:url(/images/windows-service-properties.webp)></div><h4>Golang 打开 Windows 服务属性窗口</h4><p>2021-08-01</p><div class=tags><span>Golang</span>
<span>Windows</span></div></a></div><div class=card><a href=/posts/windows-createfile-tempfile/ rel=bookmark><div class=banner style=background-image:url(/images/temp-file.jpg)></div><h4>Windows 创建临时文件</h4><p>2021-07-19</p><div class=tags><span>Windows</span></div></a></div></div></div></section><footer><span>Powered by <a href=https://gohugo.io>Hugo</a></span><br><span>© 2022 xhat</span></footer></body></html>