<!doctype html><html lang=zh-CN id=page><head><meta charset=utf-8><title>OpenSSL 生成自签名证书 - X̂ Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/font.css type=text/css rel=stylesheet><link href=/css/main.css type=text/css rel=stylesheet><link href=/css/github-markdown-light.css type=text/css rel=stylesheet><link rel=icon href=/favicon.svg></head><body><header><a href=/ id=logo><svg xmlns="http://www.w3.org/2000/svg" width="38.82" height="52.68" viewBox="0 -765 572 776" xmlns:xlink="http://www.w3.org/1999/xlink" style><defs><path id="MJX-9-TEX-I-78" d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6Q78-10 57 16T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35T107 46 94 41l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32T93 290q-2-9-5-10t-16-2H58q-6 6-6 11z"/><path id="MJX-9-TEX-N-5E" d="M112 560 249 694l8-8Q387 562 387 560l-26-29q-2 1-58 50l-53 46-55-47q-13-11-26-23t-21-19l-8-6q-2-2-15 14l-13 14z"/></defs><g stroke="currentcolor" fill="currentcolor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="TeXAtom"><g data-mml-node="mover"><g data-mml-node="mi"><use xlink:href="#MJX-9-TEX-I-78"/></g><g data-mml-node="mo" transform="translate(63.8, -29)"><use xlink:href="#MJX-9-TEX-N-5E"/></g></g></g></g></g></svg><b>xhat</b></a><nav><ul><li><a href=/ class=active>文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/archives/>归档</a></li><li><a href=/about/>关于</a></li></ul></nav></header><section class=main><article class=content><h2 class=title>OpenSSL 生成自签名证书</h2><div class=remark><time datetime="2023-09-19 23:34:26 +0800 +0800">2023-09-19</time></div><div class=tags><a href=/tags/%E7%BD%91%E7%BB%9C/>网络</a>
<a href=/tags/%E5%AE%89%E5%85%A8/>安全</a></div><div class=markdown-body><p>免费证书有效期一般较短，当服务器较多时，每个服务器都要安装脚本更新证书，管理起来比较麻烦。而合理使用自签名证书（比如测试或者非公开环境）也是不错的替代选择。</p><h2 id=生成-ca-根证书>生成 CA 根证书</h2><p><strong>CA (Certificate Authority)</strong> 被称为<strong>证书授权中心</strong>，是数字证书发放和管理的机构。</p><blockquote><p>根证书是 CA 认证中心给自己颁发的证书，是信任链的起始点。安装根证书意味着对这个 CA 认证中心的信任。</p></blockquote><h3 id=生成私钥>生成私钥</h3><p>可以选择以下任何一种算法：</p><ol><li><p><strong>椭圆曲线（ECC）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl ecparam -genkey -name secp384r1 -out ca.key
</span></span></code></pre></div><p>若需要加密私钥：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl ecparam -genkey -name secp384r1 | openssl ec -aes256 -out ca.key
</span></span></code></pre></div><p>其中 <code>-name</code> 参数指定使用的曲线，曲线名称可通过以下命令查看：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl ecparam -list_curves
</span></span></code></pre></div></li><li><p><strong>RSA</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl genrsa -out ca.key <span style=color:#099>4096</span>
</span></span></code></pre></div><p>若需要加密私钥：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl genrsa -des3 -out ca.key <span style=color:#099>4096</span>
</span></span></code></pre></div></li></ol><h3 id=生成根证书>生成根证书</h3><p>使用上面的私钥生成一个证书，证书会包含一些组织信息和公钥。为了一劳永逸有效期自然越长越好，本例设置为 73000 天（20 年）。</p><p>如果是 RSA，可以使用 <code>-sha256</code> 签名。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -key ca.key -new -x509 -days <span style=color:#099>73000</span> -sha384 -subj <span style=color:#d14>&#34;/C=CN/ST=Guangdong Province/L=Shenzhen/O=Shenzhen XXX Co., Ltd/CN=XXX Root CA&#34;</span> -out ca.crt
</span></span></code></pre></div><p>一些说明：</p><ul><li><p><code>-x509</code> 参数表明生成<strong>自签名证书</strong>，若没有传该参数，则生成一个<strong>证书请求文件</strong>（下文有例子）。</p></li><li><p><code>-subj</code> 参数填写了一些组织信息，若没有传该参数，生成时程序会进行询问。以下是信息说明：</p></li></ul><pre tabindex=0><code>国家（Country Name, C）：CN
州或省（State or Province Name, ST）：Guangdong Province
城市（Locality Name, L）：Shenzhen
组织（Organization Name, O）：Shenzhen XXX Co., Ltd
单位（Organizational Unit Name, OU）：R &amp; D Center
公用名（Common Name, CN）：XXX Root CA
邮箱（Email Address, emailAddress）：admin@example.com
</code></pre><h2 id=生成网站证书>生成网站证书</h2><p>下面以生成一个泛域名 <code>*.example.com</code> 证书为例。</p><h3 id=生成私钥-1>生成私钥</h3><p>此步骤和 CA 证书私钥生成步骤相同，只是参数可能会修改一下。</p><p>相对于根证书，客户端证书的密钥长度可以稍微小一点，但建议 RSA 至少 2048 位，ECC 至少 256 位。</p><p>同样可以选择以下任何一种算法：</p><ol><li><p><strong>椭圆曲线（ECC）</strong>：</p><p>例如使用 <code>P-256</code> 曲线：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl ecparam -genkey -name prime256v1 -out _.example.com.key
</span></span></code></pre></div></li><li><p><strong>RSA</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl genrsa -out _.example.com.key <span style=color:#099>2048</span>
</span></span></code></pre></div></li></ol><h3 id=生成证书请求文件>生成证书请求文件</h3><p>命令和上面根证书的生成差不多，注意这里是没有 <code>-x509</code> 参数的，表明生成一个证书请求文件。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -key _.example.com.key -new -subj <span style=color:#d14>&#34;/CN=*.example.com&#34;</span> -out _.example.com.csr
</span></span></code></pre></div><h3 id=使用-ca-根证书对网站证书签名>使用 CA 根证书对网站证书签名</h3><p>首先新建一个文件 <code>v3.ext</code> 填写证书的一些扩展信息：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:teal>subjectKeyIdentifier</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>hash</span>
</span></span><span style=display:flex><span><span style=color:teal>authorityKeyIdentifier</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>keyid, issuer</span>
</span></span><span style=display:flex><span><span style=color:teal>basicConstraints</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>CA:FALSE</span>
</span></span><span style=display:flex><span><span style=color:teal>keyUsage</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>digitalSignature</span>
</span></span><span style=display:flex><span><span style=color:teal>extendedKeyUsage</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>serverAuth, clientAuth</span>
</span></span><span style=display:flex><span><span style=color:teal>certificatePolicies</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>2.23.140.1.2.1</span>
</span></span><span style=display:flex><span><span style=color:teal>subjectAltName</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>@alt_names</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[alt_names]</span>
</span></span><span style=display:flex><span><span style=color:teal>DNS.1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>*.example.com</span>
</span></span></code></pre></div><p>其中 <code>alt_names</code> 可以填写多个域名和 IP，例如 <code>DNS.2 = alt.example.com</code>，<code>IP.1 = 127.0.0.1</code>。</p><p>下面命令利用 CA 根证书对网站证书进行签名，生成最终的网站证书。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl x509 -req -CA ca.crt -CAkey ca.key -days <span style=color:#099>65700</span> -sha384 -extfile v3.ext -in _.example.com.csr -out _.example.com.crt
</span></span></code></pre></div><p>如果是 RSA，可以使用 <code>-sha256</code> 签名。</p><h3 id=生成全链证书>生成全链证书</h3><p>证书以证书链的形式存在，只有当整个证书链上的证书都有效时，才会认定当前证书是合法的。</p><ol><li>最上层为<strong>根证书</strong>，也就是通常所说的 CA，用于颁发证书。</li><li>中间一层为<strong>中间证书</strong>，是二级CA，这一层可以继续划分为多层，用来帮助 CA 给用户颁发证书。</li><li>最下层为<strong>用户证书</strong>，对应是每个网站使用的 SSL 证书。</li></ol><p><strong>全链证书</strong>，顾名思义就是把整个证书链的证书都放到同一个证书文件中，具体操作如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat _.example.com.crt &lt;<span style=color:#000;font-weight:700>(</span><span style=color:#0086b3>echo</span><span style=color:#000;font-weight:700>)</span> ca.crt &gt; _.example.com.fullchain.crt
</span></span></code></pre></div><p>注意证书文件的顺序，从下层往上层依次添加证书文件。</p><p>最后，可以把证书文件 <code>_.example.com.fullchain.crt</code> 和密钥文件 <code>_.example.com.key</code> 部署到 Web 服务器。</p></div><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js onload='renderMathInElement(document.querySelector(`.content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></article></section><section class=tail><div class=content id=post-nav><a title="获取 TCP 发送缓冲区信息" rel=prev href=/posts/tcp-send-buffer/><span>前篇</span>获取 TCP 发送缓冲区信息</a></div><div class=content id=post-comment><script src=https://giscus.app/client.js data-repo=koho/blog data-repo-id="MDEwOlJlcG9zaXRvcnkzMjM1MDUxMDk=" data-category=Announcements data-category-id=DIC_kwDOE0hL1c4COeTz data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div><div class=content id=post-related><h3 class=title>延伸阅读</h3><div class=grid><div class=card><a href=/posts/tcp-send-buffer/ rel=bookmark><div class=banner style=background-image:url(/images/tcp-send-window.png)></div><h4>获取 TCP 发送缓冲区信息</h4><p>2023-05-04</p><div class=tags><span>网络</span>
<span>TCP</span></div></a></div><div class=card><a href=/posts/elliptic-curve/ rel=bookmark><div class=banner style=background-image:url(/images/ecc.png)></div><h4>ECC 椭圆曲线</h4><p>2022-09-26</p><div class=tags><span>数学</span>
<span>安全</span></div></a></div></div></div></section><footer><span>Powered by <a href=https://gohugo.io>Hugo</a></span><br><span>© 2023 xhat</span></footer></body></html>