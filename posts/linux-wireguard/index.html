<!doctype html><html lang=zh-cn id=page><head><meta charset=utf-8><title>Linux 部署 WireGuard - xhat's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/font.css type=text/css rel=stylesheet><link href=/css/main.css type=text/css rel=stylesheet><link href=/css/github-markdown-light.css type=text/css rel=stylesheet><link rel=icon href=/favicon.svg></head><body><header><a href=/ id=logo><svg xmlns="http://www.w3.org/2000/svg" width="38.82" height="52.68" viewBox="0 -765 572 776" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-9-TEX-I-78" d="M52 289q7 42 54 97t116 56q35 0 64-18t43-45q42 63 101 63 37 0 64-22t28-59q0-29-14-47t-27-22-23-4q-19 0-31 11t-12 29q0 46 50 63-11 13-40 13-13 0-19-2-38-16-56-66-60-221-60-258 0-28 16-40t35-12q37 0 73 33t49 81q3 10 6 11t16 2h4q15 0 15-8 0-1-2-11-16-57-62-101T333-11q-70 0-106 63-41-62-94-62h-6Q78-10 57 16T35 71q0 32 19 52t45 20q43 0 43-42 0-20-12-35T107 46 94 41l-3-1q0-1 6-4t16-7 19-3q36 0 62 45 9 16 23 68t28 108 16 66q5 27 5 39 0 28-15 40t-34 12q-40 0-75-32T93 290q-2-9-5-10t-16-2H58q-6 6-6 11z"/><path id="MJX-9-TEX-N-5E" d="M112 560 249 694l8-8Q387 562 387 560l-26-29q-2 1-58 50l-53 46-55-47q-13-11-26-23t-21-19l-8-6q-2-2-15 14l-13 14z"/></defs><g stroke="currentcolor" fill="currentcolor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="TeXAtom"><g data-mml-node="mover"><g data-mml-node="mi"><use xlink:href="#MJX-9-TEX-I-78"/></g><g data-mml-node="mo" transform="translate(63.8, -29)"><use xlink:href="#MJX-9-TEX-N-5E"/></g></g></g></g></g></svg><b>xhat</b></a><nav><ul><li><a href=/ class=active>文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/archives/>归档</a></li><li><a href=/about/>关于</a></li></ul></nav></header><section class=main><article class=content><h2 class=title>Linux 部署 WireGuard</h2><div class=remark><time datetime="2021-09-03 14:33:27 +0800 +0800">2021-09-03</time></div><div class=tags><a href=/tags/linux/>Linux</a>
<a href=/tags/%E7%BD%91%E7%BB%9C/>网络</a></div><div class=markdown-body><h2 id=安装>安装</h2><h3 id=centos>CentOS</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum install epel-release elrepo-release
</span></span><span style=display:flex><span>sudo yum install yum-plugin-elrepo
</span></span><span style=display:flex><span>sudo yum install kmod-wireguard wireguard-tools
</span></span></code></pre></div><h3 id=ubuntu>Ubuntu</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install wireguard
</span></span></code></pre></div><p>若内核太老不想升级，可以使用 <a href=https://git.zx2c4.com/wireguard-go/about/>wireguard-go</a> 代替。</p><h2 id=配置>配置</h2><ol><li>创建 Wireguard 目录：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir /etc/wireguard/
</span></span><span style=display:flex><span><span style=color:#0086b3>cd</span> /etc/wireguard/
</span></span></code></pre></div><ol start=2><li>生成密钥对</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wg genkey | tee privatekey | wg pubkey &gt; publickey
</span></span></code></pre></div><ol start=3><li>编辑配置文件</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vi wg0.conf
</span></span></code></pre></div><p>内容模板：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#000;font-weight:700>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:teal>Address</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>10.100.100.3/32</span>
</span></span><span style=display:flex><span><span style=color:teal>PrivateKey</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>KEY</span>
</span></span><span style=display:flex><span><span style=color:teal>ListenPort</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>21841</span>
</span></span><span style=display:flex><span><span style=color:teal>PostUp</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:teal>PostDown</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:teal>PublicKey</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>PUB</span>
</span></span><span style=display:flex><span><span style=color:teal>Endpoint</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>IP</span>
</span></span><span style=display:flex><span><span style=color:teal>AllowedIPs</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>10.100.100.3/24</span>
</span></span><span style=display:flex><span><span style=color:teal>PersistentKeepalive</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>25</span>
</span></span></code></pre></div><p>若防火墙已经手动配置好，则不需要<code>PostUp</code>和<code>PostDown</code>两句。关于<code>AllowedIPs</code>的简单解析：</p><blockquote><p>It acts as a routing table when sending, and an ACL when receiving. When a peer tries to send a packet to an IP, it will check AllowedIPs, and if the IP appears in the list, it will send it through the WireGuard interface. When it receives a packet over the interface, it will check AllowedIPs again, and if the packet’s source address is not in the list, it will be dropped.</p></blockquote><ol start=4><li>开启 IP 转发</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#0086b3>echo</span> <span style=color:#d14>&#39;net.ipv4.ip_forward = 1&#39;</span> | sudo tee -a /etc/sysctl.conf
</span></span><span style=display:flex><span>sysctl -p
</span></span></code></pre></div><ol start=6><li>启动服务</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl <span style=color:#0086b3>enable</span> wg-quick@wg0.service
</span></span><span style=display:flex><span>sudo systemctl start wg-quick@wg0.service
</span></span><span style=display:flex><span>sudo systemctl status wg-quick@wg0.service
</span></span></code></pre></div><ol start=7><li>添加 DNS 脚本</li></ol><p>如果连接时使用了域名，WireGuard 连接时会自动解析成 IP。但当域名的 IP 发生变动时，WireGuard 并不会重新解析域名。所以对于使用 DDNS 的用户，必须添加一个 DNS 解析脚本：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://raw.githubusercontent.com/WireGuard/wireguard-tools/master/contrib/reresolve-dns/reresolve-dns.sh
</span></span><span style=display:flex><span>crontab -e
</span></span></code></pre></div><p>计划任务添加一行：</p><pre tabindex=0><code>*/1 * * * * sh /etc/wireguard/reresolve-dns.sh wg0
</code></pre><p>注意<code>reresolve-dns.sh</code>脚本里用到的<code>$EPOCHSECONDS</code>这个变量，如果你的系统不支持，需要替换成<code>$(date +%s)</code>。</p><h2 id=参考>参考</h2><p>[1] <a href=https://www.stavros.io/posts/how-to-configure-wireguard/>How to easily configure WireGuard</a></p></div><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js onload='renderMathInElement(document.querySelector(`.content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script></article></section><section class=tail><div class=content id=post-nav><a title="Golang 打开 Windows 服务属性窗口" rel=prev href=/posts/golang-service-property/><span>前篇</span>Golang 打开 Windows 服务属性窗口</a>
<a title="Golang 在 Windows 下防止程序多开" rel=next href=/posts/golang-gui-singleton/><span>后篇</span>Golang 在 Windows 下防止程序多开</a></div><div class=content id=post-comment><script src=https://giscus.app/client.js data-repo=koho/blog data-repo-id="MDEwOlJlcG9zaXRvcnkzMjM1MDUxMDk=" data-category=Announcements data-category-id=DIC_kwDOE0hL1c4COeTz data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div><div class=content id=post-related><h3 class=title>延伸阅读</h3><div class=grid><div class=card><a href=/posts/python-arpspoof/ rel=bookmark><div class=banner style=background-image:url(/images/cyber-security.jpg)></div><h4>Python 进行 ARP 欺骗</h4><p>2021-06-09</p><div class=tags><span>Python</span>
<span>网络</span></div></a></div><div class=card><a href=/posts/openwrt-pon-stick/ rel=bookmark><div class=banner style=background-image:url(/images/image-20210206141943.jpg)></div><h4>OpenWrt + Pon Stick 配置教程</h4><p>2021-02-06</p><div class=tags><span>OpenWrt</span>
<span>网络</span></div></a></div></div></div></section><footer><span>Powered by <a href=https://gohugo.io>Hugo</a></span><br><span>© 2022 xhat</span></footer></body></html>